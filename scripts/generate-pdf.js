const fs = require('fs');
const path = require('path');
const puppeteer = require('puppeteer');

function readSvg(name) {
  const p = path.join(__dirname, '..', 'public', 'images', name);
  return fs.readFileSync(p, 'utf8');
}

function htmlTemplate() {
  const cpi = readSvg('cpi_trend.svg');
  const money = readSvg('money_supply.svg');
  const types = readSvg('inflation_types.svg');

  return `<!DOCTYPE html>
  <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet" />
      <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Noto Naskh Arabic','Cairo',sans-serif; color: #0b1020; }
        .title { font-size: 24px; font-weight: 800; margin: 0 0 8px; }
        .subtitle { color: #333; margin: 0 0 16px; }
        h2 { font-size: 18px; margin: 14px 0 6px; }
        p, li { font-size: 12.5px; line-height: 1.9; }
        .figure { border: 1px solid #e5e7eb; border-radius: 8px; margin: 8px 0 4px; overflow: hidden; }
        .caption { color: #6b7280; font-size: 11px; margin: 4px 0 10px; }
        .pill { display: inline-block; border: 1px dashed #c7d2fe; padding: 3px 8px; border-radius: 999px; margin: 2px; font-size: 11px; color: #1f2937; }
        .page-break { page-break-after: always; }
      </style>
    </head>
    <body>
      <div>
        <div class="title">??? ??? ??????</div>
        <div class="subtitle">????? ?????? ?????? ????? ????? ?????? ??????? ???????</div>

        <h2>????? ??????</h2>
        <p>
          ?????? ?? ???????? ??????? ?? ??????? ????? ??????? ??? ?????? ?? ???? ??? ???? ????? ???????? ??????.
          ????? ???????? ??? ?????? ?????? ???? ????? ???????? (CPI) ?????? ?????? ?????? ?????? ????????.
        </p>
        <div>
          <span class="pill">????? ????? ????????</span>
          <span class="pill">????? ????????</span>
          <span class="pill">??????? ????? ???????</span>
        </div>
        <div class="figure">${cpi}</div>
        <div class="caption">??? (1): ????? ??????? ????? ????? ????????</div>

        <h2>????? ??????</h2>
        <p>
          ???? ??? ?????? ??????? ?????? ????? ?????? ????? ?????? ?????????? ????? ???????? ????? ?????? ?????? ?? ????????? ??????? ??????? ??????? ????????? ????? ????? ?????. ??? ???? ???????? ????????? ?????? ???????? ???? ??????? ?? ????? ?????? ???????.
        </p>
        <ul>
          <li>??? ?????? ????? ??????</li>
          <li>?????? ?????? ??????? (??????? ??????? ?????? ?????)</li>
          <li>???????? ??????? ??????????</li>
          <li>?????? ?????? ?????? ???? ?????</li>
        </ul>
        <div class="figure">${money}</div>
        <div class="caption">??? (2): ????? ??? ?????? ??????? ???????</div>

        <div class="page-break"></div>

        <h2>????? ??????</h2>
        <p>
          ??????: ?????? ????? ????. ?? ??? ???????: ????? ?? ????? ????????. ??? ???? ???? ?????? ????? ?????? ????? ???????? ???? ?????? ????? ???? ???? ?? ????? ?????? ?? ???? ??????? ????????.
        </p>
        <div class="figure">${types}</div>
        <div class="caption">??? (3): ????? ???? ?????? ??????</div>

        <h2>???? ??????</h2>
        <p>
          ????? ??? ???? ???? ????? ?????. ?????? ?????? = (CPI_t ? CPI_{t-12}) / CPI_{t-12} ? 100.
          ????? ??????? ?????????? ??? ????? ????? ?????? ?????????.
        </p>

        <h2>?????? ??????????</h2>
        <ul>
          <li>???? ????? ???????? ????????</li>
          <li>????? ?????? ??????? ?????? ????????</li>
          <li>????? ????? ????? ??? ???????? ?????????</li>
          <li>????? ??? ????????? ?????? ??? ?????? ??????</li>
        </ul>

        <h2>????????</h2>
        <ul>
          <li>??????? ???????: ????? ??? ??????? ??????? ??????</li>
          <li>??????? ???????: ??? ????? ?????? ????? ??????</li>
          <li>???? ?????: ?????????? ????????? ?????? ???????? ??????????</li>
        </ul>

        <h2>????? ??????</h2>
        <p>
          ?????? ????? ????? ?????? ??????? ???????? ???????? ???? ?????? ????? ???????? ?????? ???????? ????? ???????.
        </p>
      </div>
    </body>
  </html>`;
}

async function main() {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();
  await page.setContent(htmlTemplate(), { waitUntil: 'networkidle0' });
  const outPath = path.join(__dirname, '..', 'public', 'inflation.pdf');
  await page.pdf({ path: outPath, format: 'A4', printBackground: true });
  await browser.close();
  console.log('PDF written to:', outPath);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
